<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>玻璃圆角裁切工具（自适应版）</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 40px; background: #f0f0f0; }
    #preview-container { position: relative; display: inline-block; background: transparent; overflow: hidden; }
    svg { max-width: 100%; height: auto; display: block; background: transparent; }
  </style>
</head>
<body>
  <h2>玻璃圆角裁切工具</h2>
  <div style="text-align: center; line-height: 1.5; font-size: 16px; margin-top: -10px; margin-bottom: 20px;">
    Made by Dr. Sean Group<br>
  </div>
  <input type="file" id="fileInput" accept="image/*"><br><br>
  <div id="controls" style="display:none;">
    圆角半径: <input type="range" id="radiusRange" min="0" max="500" value="40">
    <span id="radiusValue">40</span>px<br><br>
    背景模式:
    <select id="modeSelect">
      <option value="transparent">透明背景</option>
      <option value="black">黑色背景</option>
    </select><br><br>
    <button id="downloadBtn">下载高清图片</button>
  </div>

  <div id="preview-container">
    <svg id="svgPreview" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <clipPath id="clipRounded">
          <rect id="clipRect" x="0" y="0" rx="40" ry="40"/>
        </clipPath>
      </defs>
      <rect id="bgRect" x="0" y="0" fill="black" visibility="hidden"/>
      <image id="uploadedImage" href=""
             preserveAspectRatio="xMidYMid meet" clip-path="url(#clipRounded)" />
    </svg>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const svg = document.getElementById('svgPreview');
    const imageEl = document.getElementById('uploadedImage');
    const clipRect = document.getElementById('clipRect');
    const bgRect = document.getElementById('bgRect');
    const radiusRange = document.getElementById('radiusRange');
    const radiusValue = document.getElementById('radiusValue');
    const modeSelect = document.getElementById('modeSelect');
    const controls = document.getElementById('controls');
    const downloadBtn = document.getElementById('downloadBtn');

    let imgWidth = 600;
    let imgHeight = 400;

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          imgWidth = img.naturalWidth;
          imgHeight = img.naturalHeight;

          // 限制最大尺寸，防止超大图太大
          const maxW = 1000;
          const scale = imgWidth > maxW ? maxW / imgWidth : 1;

          imgWidth = imgWidth * scale;
          imgHeight = imgHeight * scale;

          svg.setAttribute('width', imgWidth);
          svg.setAttribute('height', imgHeight);
          clipRect.setAttribute('width', imgWidth);
          clipRect.setAttribute('height', imgHeight);
          bgRect.setAttribute('width', imgWidth);
          bgRect.setAttribute('height', imgHeight);
          imageEl.setAttribute('width', imgWidth);
          imageEl.setAttribute('height', imgHeight);
          imageEl.setAttribute('href', event.target.result);

          controls.style.display = 'block';
          updateMask();
        }
        img.src = event.target.result;
      }
      reader.readAsDataURL(file);
    });

    function updateMask() {
      const radius = parseInt(radiusRange.value);
      radiusValue.textContent = radius;
      clipRect.setAttribute('rx', radius);
      clipRect.setAttribute('ry', radius);

      if (modeSelect.value === 'black') {
        bgRect.setAttribute('visibility', 'visible');
        svg.style.background = 'black';
      } else {
        bgRect.setAttribute('visibility', 'hidden');
        svg.style.background = 'transparent';
      }
    }

    radiusRange.addEventListener('input', updateMask);
    modeSelect.addEventListener('change', updateMask);

    downloadBtn.addEventListener('click', () => {
      const svgData = new XMLSerializer().serializeToString(svg);
      const canvas = document.createElement('canvas');

      const scale = 2; // 超采样比例
      const w = svg.width.baseVal.value;
      const h = svg.height.baseVal.value;

      canvas.width = w * scale;
      canvas.height = h * scale;

      const ctx = canvas.getContext('2d');
      const img = new Image();
      const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);

      img.onload = function() {
        ctx.save();
        ctx.scale(scale, scale);  // 放大坐标系
        ctx.drawImage(img, 0, 0, w, h); // 按正常比例绘制
        ctx.restore();

        URL.revokeObjectURL(url);
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = 'rounded_image_hd.png';
        a.click();
      }
      img.src = url;
    });
  </script>
</body>
</html>
